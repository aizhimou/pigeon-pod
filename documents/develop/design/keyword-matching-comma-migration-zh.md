# Feed 关键词匹配现状与逗号分隔升级说明

## 1. 目的

本文说明 PigeonPod 当前 Feed 关键词过滤（标题/描述包含与排除）的前后端实现现状、已有问题，以及将分隔规则升级为“前后端统一只认逗号分隔”时需要处理的数据与兼容问题。

---

## 2. 当前实现现状

## 2.1 前端（输入与回显）

页面组件：`frontend/src/components/EditFeedModal.jsx`

- `parseKeywords`：使用 `split(/[,\s]+/)` 拆分关键词（逗号或任意空白都会拆分）。
- `formatKeywords`：保存时使用 `keywords.join(' ')`，最终以空格拼接后提交给后端。
- `TagsInput` 的 `splitChars={[',']}` 也会将逗号作为标签分隔。

结论：
- 在当前 UI 中，用户输入时“空格”和“逗号”都可拆词。
- 但提交后实际落库格式通常是“空格分隔字符串”。

## 2.2 后端（过滤规则）

核心代码：`backend/src/main/java/top/asimov/pigeon/helper/YoutubeVideoHelper.java`

- `notMatchesKeywordFilter(String title, String containKeywords, String excludeKeywords)`：
  - `containKeywords` 非空时：`split("\\s+")` 按空白拆分，任一关键词命中即通过（OR）。
  - `excludeKeywords` 非空时：`split("\\s+")` 按空白拆分，任一关键词命中即排除（OR）。
  - 匹配方式：`toLowerCase().contains(...)`（大小写不敏感子串匹配）。
- 在 `buildEpisodeIfMatches(...)` 中：
  - 标题过滤通过后，才进行描述过滤。
  - 标题与描述两组过滤关系是 AND（都要通过）。

## 2.3 数据层

字段位于 `channel` / `playlist` 对应实体 `Feed` 的以下列：

- `title_contain_keywords`
- `title_exclude_keywords`
- `description_contain_keywords`
- `description_exclude_keywords`

当前历史数据大概率以“空格分隔”为主（因为前端格式化后保存为 `join(' ')`）。

---

## 3. 当前问题

## 3.1 前后端分隔规则不完全一致

- 前端拆分：逗号 + 空白。
- 后端拆分：仅空白。

这会导致“规则来源不唯一”，用户理解成本更高，也会增加绕过前端直接调用 API 时的行为差异。

## 3.2 输入体验与存储语义存在偏差

- 用户在前端可以把逗号当分隔符输入，但最终落库会被格式化为空格分隔。
- 这不利于建立“所见即所得”的参数心智。

## 3.3 表达能力限制（与分隔符无关，但需知晓）

- 目前是子串匹配，不支持“整词匹配”与“短语精确匹配”。
- 例如关键词 `art` 会命中 `smart`。

---

## 4. 升级目标：前后端统一为“仅逗号分隔”

目标定义（严格模式）：

- 前端：仅按逗号拆词与展示。
- 后端：仅按逗号拆词进行过滤。
- 数据库存储：统一为逗号分隔格式。

---

## 5. 是否需要修复历史数据

结论：**需要**（在严格模式下）。

原因：

- 旧数据多为空格分隔。
- 如果后端改为只按逗号拆分，而不处理历史数据，原有 `"foo bar"` 会被当成一个整体关键词，匹配结果改变，导致行为回归风险。

---

## 6. 推荐迁移策略（低风险）

建议采用“两阶段迁移”，避免一次切换造成线上行为突变。

## 阶段 A：兼容读 + 新写入逗号格式

- 后端临时兼容拆分：同时支持逗号和空白（例如 `[,\\s]+`）。
- 前端改为仅逗号输入提示，保存时统一 `join(',')`。
- 此阶段不强制立即清洗历史数据，先保证功能平滑过渡。

## 阶段 B：历史数据归一化 + 收敛规则

- 对 `channel` / `playlist` 四个关键词字段进行批量归一化：
  - 清理首尾空白；
  - 将连续空白替换为逗号；
  - 将重复逗号压缩为单逗号；
  - 清理逗号两侧空白。
- 数据清洗完成并验证后，后端可收敛为仅逗号分隔逻辑。

---

## 7. 迁移风险与验证重点

## 7.1 风险点

- 关键词边界变化导致过滤结果变化（尤其历史空格数据未清洗时）。
- 部分用户可能输入了“带空格短语”，转换时会被拆成多个词（当前系统本就不支持短语精确匹配，需要在说明中明确）。

## 7.2 验证清单

- 新增/编辑 Feed 后，回显仍为逗号分隔且语义不变。
- 标题与描述的 contains/excludes 逻辑不变（contains-OR、excludes-OR、title+description-AND）。
- 迁移前后同一 Feed 在样本视频集上的过滤结果一致（或在预期范围内变化并可解释）。
- 直接 API 调用与前端操作行为一致。

---

## 8. 建议结论

如果要统一为“前后端都只认逗号分隔”，最佳落地方式是：

1. 先做兼容过渡（后端兼容读、前端统一逗号写）；
2. 再做历史数据归一化；
3. 最后收敛为严格仅逗号分隔。

这样可以在不牺牲一致性的前提下，最大程度降低线上回归风险。
